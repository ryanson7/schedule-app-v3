// scripts/generate-menu.js
const fs = require('fs');
const path = require('path');

// íŽ˜ì´ì§€ ìŠ¤ìº” í•¨ìˆ˜
function scanPages(dir = 'src/pages') {
  const menuItems = [];
  
  function scanDir(currentDir, urlPath = '') {
    try {
      const files = fs.readdirSync(currentDir);
      
      files.forEach(file => {
        const fullPath = path.join(currentDir, file);
        const stat = fs.statSync(fullPath);
        
        if (stat.isDirectory() && !['api', 'auth'].includes(file)) {
          scanDir(fullPath, `${urlPath}/${file}`);
        } else if (file.endsWith('.tsx') && !file.startsWith('_')) {
          const fileName = file.replace('.tsx', '');
          const pagePath = fileName === 'index' 
            ? urlPath || '/' 
            : `${urlPath}/${fileName}`;
          
          // íŒŒì¼ ë‚´ìš© ì½ê¸°
          const content = fs.readFileSync(fullPath, 'utf8');
          const meta = extractMeta(content);
          
          if (meta.title) {
            menuItems.push({
              id: pagePath.replace(/\//g, '-') || 'home',
              path: pagePath,
              name: meta.title,
              icon: meta.icon || 'ðŸ“„',
              category: meta.category || 'ê¸°ë³¸',
              defaultRoles: meta.roles || ['system_admin']
            });
          }
        }
      });
    } catch (error) {
      console.error(`ë””ë ‰í† ë¦¬ ìŠ¤ìº” ì˜¤ë¥˜: ${currentDir}`, error);
    }
  }
  
  scanDir(dir);
  return menuItems;
}

// ë©”íƒ€ë°ì´í„° ì¶”ì¶œ í•¨ìˆ˜
function extractMeta(content) {
  const meta = {};
  
  const titleMatch = content.match(/@menu-title\s+(.+)/);
  const iconMatch = content.match(/@menu-icon\s+(.+)/);
  const rolesMatch = content.match(/@menu-roles\s+(.+)/);
  const categoryMatch = content.match(/@menu-category\s+(.+)/);
  
  if (titleMatch) meta.title = titleMatch[1].trim();
  if (iconMatch) meta.icon = iconMatch[1].trim();
  if (rolesMatch) meta.roles = rolesMatch[1].split(',').map(r => r.trim());
  if (categoryMatch) meta.category = categoryMatch[1].trim();
  
  return meta;
}

// ë©”ë‰´ íŒŒì¼ ìƒì„±
function generateMenuFile() {
  const autoMenus = scanPages();
  
  const menuCode = `// ìžë™ ìƒì„±ëœ ë©”ë‰´ íŒŒì¼ (ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”!)
// íŽ˜ì´ì§€ íŒŒì¼ì˜ @menu-* ì£¼ì„ì—ì„œ ìžë™ ìƒì„±ë¨
// ìƒì„± ì‹œê°„: ${new Date().toLocaleString('ko-KR')}

export const AUTO_GENERATED_MENUS = ${JSON.stringify(autoMenus, null, 2)};
`;

  // src/utils ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
  const utilsDir = 'src/utils';
  if (!fs.existsSync(utilsDir)) {
    fs.mkdirSync(utilsDir, { recursive: true });
  }

  fs.writeFileSync('src/utils/autoGeneratedMenus.ts', menuCode);
  console.log(`ë©”ë‰´ ìƒì„± ì™„ë£Œ: ${autoMenus.length}ê°œ í•­ëª©`);
  
  // ìƒì„±ëœ ë©”ë‰´ ë¯¸ë¦¬ë³´ê¸°
  autoMenus.forEach(menu => {
    console.log(`  - ${menu.icon} ${menu.name} (${menu.path})`);
  });
}

// ì‹¤í–‰
generateMenuFile();
